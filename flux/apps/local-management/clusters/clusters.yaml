apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: argocd-clusters
  namespace: argocd
spec:
  generators:
    - list:
        elements: 
          - clusterName: "local-staging"
            server: "https://172.17.0.5:8443"
            bearerTokenSecretRef:
              name: "staging-cluster-bearer-token"
              namespace: argocd
              key: token
            caDataSecretRef:
              name: "staging-cluster-ca-cert"
              namespace: argocd
              key: "ca.pem"
          # - clusterName: "local-production"
          #   server: "https://172.17.0.8:8443"
          #   bearerTokenSecretRef:
          #     name: "production-cluster-bearer-token"
          #     namespace: argocd
          #     key: token
          #   caDataSecretRef:
          #     name: "production-cluster-ca-cert"
          #     namespace: argocd
          #     key: "ca.pem"
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]              
  template:
    metadata:
      name: '{{ .clusterName }}-cluster-secret'
    spec:
      project: default
      source:
        repoURL: "https://github.com/huseyindeniz/gitops-lab.git"
        targetRevision: HEAD
        path: "helm-charts/cluster"
        helm:
          valuesObject:
            clusterName: "{{ .clusterName }}"
            server: "{{ .server }}"
            bearerTokenSecretName: "{{ .bearerTokenSecretRef.name }}"
            bearerTokenSecretKey: "{{ .bearerTokenSecretRef.key }}"
            bearerTokenSecretNamespace: "{{ .bearerTokenSecretRef.namespace }}"
            caDataSecretName: "{{ .caDataSecretRef.name }}"
            caDataSecretKey: "{{ .caDataSecretRef.key }}"
            caDataSecretNamespace: "{{ .caDataSecretRef.namespace }}"
      destination:
        server: https://kubernetes.default.svc
        namespace: argocd
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
