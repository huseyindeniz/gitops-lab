name: Harbor - SampleAI Backend - Build and push Docker images

on:
  workflow_dispatch:

jobs:
  build-push:
    runs-on: arc-runner-local-staging
    steps:
      - name: Get current timestamp
        run: |
          export LC_ALL=C
          echo "TIMESTAMP=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Build and Push with Kaniko
        run: |
          sudo mkdir -p /kaniko
          sudo curl -L -o /kaniko/executor https://github.com/GoogleContainerTools/kaniko/releases/latest/download/executor
          sudo chmod +x /kaniko/executor
  
          /kaniko/executor \
            --context=apps/sample-ai/backend \
            --dockerfile=apps/sample-ai/backend/Dockerfile \
            --destination=harbor.staging.local:44302/library/sample-ai-backend-staging:${{ env.TIMESTAMP }} \
            --insecure
