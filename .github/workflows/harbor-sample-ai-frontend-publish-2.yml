name: Harbor - SampleAI Frontend 2 - Build and push Docker images 

on:
  workflow_dispatch:

jobs:
         
  build-push:
    runs-on: arc-runner-local-staging
    steps:
      - name: Get Harbor Auth Token (HTTPS)
        run: |
          export HARBOR_TOKEN=$(curl -s -X POST \
            "https://harbor.staging.local:44302/service/token?account=${{ secrets.HARBOR_USERNAME }}&client_id=docker&offline_token=true&service=harbor-registry" \
            -u "${{ secrets.HARBOR_USERNAME }}:${{ secrets.HARBOR_TOKEN }}" | jq -r .token)
          echo "HARBOR_TOKEN=${HARBOR_TOKEN}" >> $GITHUB_ENV
      - name: Login to Harbor registry (HTTPS)
        run: |
          # Login to Harbor registry using the token via HTTPS
          echo $HARBOR_TOKEN | docker login harbor.staging.local:44302 -u ${{ secrets.HARBOR_USERNAME }} --password-stdin      
      - name: Get current timestamp
        run: |
          export LC_ALL=C
          echo "TIMESTAMP=$(date +%Y%m%d%H%M%S)" >> $GITHUB_ENV
      - name: Checkout code
        uses: actions/checkout@v4       
      - name: Build Docker image
        run: |
            docker build -t harbor.staging.local/library/sample-ai-frontend-staging:${{ env.TIMESTAMP }} \
            --build-arg BUILD_ENV=staging \
            -f apps/sample-ai/frontend/Dockerfile \
            apps/sample-ai/frontend
      - name: Push Docker image to Harbor
        run: |
          # Push the image to Harbor
          docker push harbor.staging.local/library/sample-ai-frontend-staging:${{ env.TIMESTAMP }}